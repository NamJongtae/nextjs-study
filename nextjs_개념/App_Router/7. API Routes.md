# 7. API Routes
> Next.js ë‚´ì—ì„œ API EndPointë¥¼ ì‰½ê²Œ ì •ì˜í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜(Serverless Functions)ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìœ¼ë©°, Full Stack ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br>

## 7-1. API Router ìƒì„±

API RouterëŠ” `app/api` í´ë” í•˜ìœ„ì— í´ë”ë¥¼ ìƒì„±í•˜ë©´ í•´ë‹¹ ê²½ë¡œë¡œ API EndPointê°€ ìƒì„±ë˜ë©°, `route.js` íŒŒì¼ì„ ìƒì„±í•˜ì—¬ API handler í•¨ìˆ˜ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

```text
ğŸ“¦app
 â”£ ğŸ“‚api
 â”ƒ â”— ğŸ“‚user
 â”ƒ  â”— ğŸ“œroute.js
 â”£ ğŸ“œfavicon.ico
 â”£ ğŸ“œglobals.css
 â”£ ğŸ“œlayout.js
 â”— ğŸ“œpage.js
```

<br>

## 7-2. API Router handler ì‘ì„±
`API Method(GET, POST, PATCH, PUT, DELETE ë“±)` ë³„ë¡œ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```javascript
export async function GET(req: Request){}

export async function POST(req: Request) {}

export async function PUT(req: Request) {}

export async function DELETE(req: Request) {}

export async function PATCH(req: Request) {}
```

<br>

## 7-3. API Router handler ìºì‹±
GET handler í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ API EndPointê°€ ìºì‹±ë©ë‹ˆë‹¤. GET Method ì´ì™¸ì˜ handlerì˜ ê²½ìš° ë™ì ìœ¼ë¡œ í‰ê°€ë˜ë©°, API EndPoint ìºì‹±ì´ ì´ë£¨ì–´ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.

```javascript
export async function GET() {
  const res = await fetch('https://data.mongodb-api.com/...', {
    headers: {
      'Content-Type': 'application/json',
      'API-Key': process.env.DATA_API_KEY,
    },
  });
  const data = await res.json();
 
  return NextResponse.json({ data });
}
```

handler í•¨ìˆ˜ì˜ ì¸ìë¡œ ë°›ì€ requestë¥¼ ì‚¬ìš©í•  ê²½ìš° ìºì‹±ì´ ì´ë£¨ì–´ì§€ì§€ ì•Šìœ¼ë©°, ë§¤ë²ˆ ìƒˆë¡œìš´ ìš”ì²­ì´ ìƒì„±ë©ë‹ˆë‹¤. requestëŠ” cookies, headersì™€ ê°™ì€ ë™ì  í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```javascript
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const id = searchParams.get('id');
  const res = await fetch(`https://data.mongodb-api.com/product/${id}`, {
    headers: {
      'Content-Type': 'application/json',
      'API-Key': process.env.DATA_API_KEY,
    },
  });
  const product = await res.json();
 
  return NextResponse.json({ product });
}
```
ìºì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° fetchì˜ next.revalidate ì˜µì…˜ì„ í†µí•´ ë°ì´í„°ë¥¼ ì¬ê²€ì¦í•˜ì—¬ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜¹ì€ API router íŒŒì¼ ìƒë‹¨ `export const revalidate = 60`ë¥¼ ì •ì˜í•˜ì—¬ í•´ë‹¹ ê²½ë¡œì˜ ëª¨ë“  handlerì˜ ì¬ê²€ì¦ ì‹œê°„ì„ í•œ ë²ˆì— ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

60ì´ˆë§ˆë‹¤ ì¬ê²€ì¦ì´ ìš”ì²­ë˜ì–´ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ì ìš©í•©ë‹ˆë‹¤.

```javascript
export const revalidate = 60;

export async function GET() {
  const res = await fetch('https://data.mongodb-api.com/...', {
    next: { revalidate: 60 }, // Revalidate every 60 seconds
  });
  const data = await res.json();
 
  return NextResponse.json(data);
}
```

<br>

## 7-4. ë™ì  ê²½ë¡œ ì„¸ê·¸ë¨¼íŠ¸ ê°€ì ¸ì˜¤ê¸°
handler í•¨ìˆ˜ì˜ ë‘ ë²ˆì§¸ ì¸ìì¸ `params` ê°ì²´ë¥¼ í†µí•´ ë™ì  ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê²½ë¡œê°€ ì•„ë˜ì™€ ê°™ë‹¤ë©´:

```text
ğŸ“¦app
 â”£ ğŸ“‚api
 â”ƒ â”— ğŸ“‚user
 â”ƒ    â”— ğŸ“‚[slug]
 â”ƒ       â”— ğŸ“œroute.ts
 â”£ ğŸ“œfavicon.ico
 â”£ ğŸ“œglobals.css
 â”£ ğŸ“œlayout.js
 â”— ğŸ“œpage.js
```
`params`ë¥¼ í†µí•´ `slug`ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```javascript
export async function GET(
  request: Request,
  { params }: { params: { slug: string } }
) {
  const slug = params.slug; // 'a', 'b', or 'c'
}
```

<br>

## 7-5. Request

### request.json()
`request.json()`ë¥¼ ì‚¬ìš©í•˜ì—¬ bodyë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```javascript
export async function POST(request: Request) {
  const res = await request.json();
  return NextResponse.json({ res });
}
```

<br>

### request.formData()
`request.formData()`ë¥¼ í†µí•´ FormDataë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```javascript
export async function POST(request: Request) {
  const formData = await request.formData();
  const name = formData.get('name');
  const email = formData.get('email');
  return NextResponse.json({ name, email });
}

```

<br>

## 7-6. NextResponse
`NextResponse`ëŠ” Web ì‘ë‹µ APIë¥¼ í™•ì¥í•˜ë©°, ì¶”ê°€ì ì¸ í¸ì˜ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.

### json()
`NextResponse.json()`: ì£¼ì–´ì§„ JSON ë³¸ë¬¸ìœ¼ë¡œ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤. handler í•¨ìˆ˜ì—ì„œ JSONì„ í†µí•´ ìƒì„±í•œ ì‘ë‹µì„ ë°˜í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```javascript
export async function POST(request: Request) {
  const formData = await request.formData();
  const name = formData.get('name');
  const email = formData.get('email');
  return NextResponse.json({ name, email }, { status: 200 });
}
```

<br>

### cookies
headerì˜ ì¿ í‚¤ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`NextResponse.cookies.get(name)`: ì¿ í‚¤ ì´ë¦„ì´ ì£¼ì–´ì§€ë©´ ì¿ í‚¤ì˜ ê°’ì„ ë°˜í™˜í•©ë‹ˆë‹¤. ì¿ í‚¤ê°€ ë°œê²¬ë˜ì§€ ì•Šìœ¼ë©´, undefinedë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì—¬ëŸ¬ ê°œì˜ ì¿ í‚¤ê°€ ë°œê²¬ë˜ë©´, ì²« ë²ˆì§¸ ì¿ í‚¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

```javascript
// Given incoming request /home
let response = NextResponse.next();
// { name: 'show-banner', value: 'false', Path: '/home' }
response.cookies.get('show-banner');
```

`NextResponse.cookies.getAll()`: ì¿ í‚¤ ì´ë¦„ì´ ì£¼ì–´ì§€ë©´ ì¿ í‚¤ì˜ ê°’ì„ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ë¦„ì´ ì£¼ì–´ì§€ì§€ ì•Šìœ¼ë©´ ì‘ë‹µì—ì„œ ëª¨ë“  ì¿ í‚¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

```javascript
// Given incoming request /home
let response = NextResponse.next();
// { name: 'show-banner', value: 'false', Path: '/home' }
response.cookies.get('show-banner');
```

`NextResponse.cookies.set(name, value)`: ì´ë¦„ì´ ì£¼ì–´ì§€ë©´, í•´ë‹¹ ê°’ì„ ê°€ì§„ ì¿ í‚¤ë¥¼ ì‘ë‹µì— ì„¤ì •í•©ë‹ˆë‹¤.

```javascript
// Given incoming request /home
let response = NextResponse.next();
// Set a cookie to hide the banner
response.cookies.set('show-banner', 'false');
// Response will have a `Set-Cookie:show-banner=false;path=/home` header
return response;
```

`NextResponse.cookies.delete(name)`: ì¿ í‚¤ ì´ë¦„ì´ ì£¼ì–´ì§€ë©´ ì‘ë‹µì—ì„œ ì¿ í‚¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.

```javascript
// Given incoming request /home
let response = NextResponse.next();
// Returns true for deleted, false if nothing is deleted
response.cookies.delete('experiments');
```

<br>

### redirect()
URLë¡œ ë¦¬ë””ë ‰ì…˜ë˜ëŠ” ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.

```javascript
import { NextResponse } from 'next/server';
 
// Given an incoming request...
const loginUrl = new URL('/login', request.url);
// Add ?from=/incoming-url to the /login URL
loginUrl.searchParams.set('from', request.nextUrl.pathname);
// And redirect to the new URL
return NextResponse.redirect(loginUrl);
```

### rewrite()

ì£¼ì–´ì§„ URLì„ ë‹¤ì‹œ ì“°ëŠ”(í”„ë¡ì‹œ) ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤. ì›ë˜ URLì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.

```javascript
import { NextResponse } from 'next/server';
 
// Incoming request: /about, browser shows /about
// Rewritten request: /proxy, browser shows /about
return NextResponse.rewrite(new URL('/proxy', request.url));
```

<br>

### next()
middleware ì²˜ë¦¬ ë‹¨ê³„ì—ì„œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ë„ë¡ ì§€ì‹œí•˜ëŠ” ê¸°ëŠ¥ì„ í•©ë‹ˆë‹¤. NextResponse.next()ë¥¼ í˜¸ì¶œí•˜ë©´ í˜„ì¬ ë¯¸ë“¤ì›¨ì–´ì˜ ì²˜ë¦¬ê°€ ëë‚˜ê³ , ìš”ì²­ì´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤. ì´ëŠ” ì—¬ëŸ¬ ë¯¸ë“¤ì›¨ì–´ê°€ ìˆœì°¨ì ìœ¼ë¡œ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

```javascript
import { NextResponse } from 'next/server';
// ...
return NextResponse.next();
```

<br>

## ì°¸ê³  ì‚¬ì´íŠ¸
- https://nextjs.org/docs/app/api-reference/file-conventions/route
- https://nextjs.org/docs/app/building-your-application/routing/route-handlers
- https://nextjs.org/docs/app/api-reference/functions/next-response