# 3. Server Action
> ì„œë²„ì—ì„œ ë¹„ë™ê¸° ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.
> ì„œë²„ ì•¡ì…˜ì„ ì‚¬ìš©í•˜ë©´, API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ìƒì„±í•˜ì§€ ì•Šê³ ë„ ì»´í¬ë„ŒíŠ¸ ë‚´ì—ì„œ ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ ì§ì ‘ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br>

## 3-1. Server Action ì •ì˜
í•¨ìˆ˜ ì•ˆ ìµœìƒë‹¨ `use server`ë¥¼ ì„ ì–¸í•˜ê³ , `async` í‚¤ì›Œë“œë¥¼ ë¶™ì´ë©´ ì„œë²„ì—ì„œ ë™ì‘í•˜ëŠ” **Server Action**ì´ ë©ë‹ˆë‹¤.
```javascript
async function UploadPost() {
  'use server"
  //...
}
```

í•œ íŒŒì¼ ë‚´ì— ì—¬ëŸ¬ Server Actionì„ ì •ì˜í•˜ëŠ” ê²½ìš° íŒŒì¼ ìµœìƒë‹¨ì— `use server`ë¥¼ í•œë²ˆë§Œ ì„ ì–¸í•˜ë©´ë©ë‹ˆë‹¤.
```javascript
'use server'

async function UploadPost() {
  //...
}

async function DeletePost() {
  //...
}
```

<br>

## 3-2. Server Action ì‚¬ìš©
Server Action ì‚¬ìš©ì„ ìœ„í•´ ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì„ ìœ„í•´ `better-sqlite3` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.

### Server Action í•¨ìˆ˜ ìƒì„±
```javascript
"use server";

const sql = require("better-sqlite3");
import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";

const db = sql("posts.db");
export const getPosts = async () => {
  await new Promise((res) => setTimeout(res, 2000));
  return db.prepare("SELECT * FROM posts").all();
};

export async function upload(formData: FormData) {
  const title = formData.get("title") as string | null;
  const content = formData.get("content") as string | null;

  let errors = [];

  if (!title || title.trim().length === 0) {
    errors.push("Title is required.");
  }

  if (!content || content.trim().length === 0) {
    errors.push("Content is required.");
  }

  if (errors.length > 0) {
    return { errors };
  }

  const post = {
    title: formData.get("title"),
    content: formData.get("content"),
  };

  await savePost(post);
  revalidatePath("/posts");
  redirect("/posts");
}

export async function savePost(post: {
  title: FormDataEntryValue | null;
  content: FormDataEntryValue | null;
}) {
  db.prepare(
    `
    INSERT INTO posts
      (title, content)
    VALUES (
      @title,
      @content
    )
  `
  ).run(post);
}
```

<br>

### Server Action ì ìš©í•˜ê¸°
form actionë¥¼ í†µí•´ Server Actionë¥¼ ì „ë‹¬í•´ì£¼ì–´ Server Actionë¥¼ ì ìš©í•©ë‹ˆë‹¤.

ğŸ’¡ **from action**
> from actionì€ ë°ì´í„°ê°€ ì „ì†¡ë  ì„œë²„ì˜ URLì„ ì§€ì •í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
- nextjsì—ì„œ server actionë¥¼ ì „ë‹¬í•˜ë©´ server actions ê¸°ëŠ¥ìœ¼ë¡œ ë™ì‘í•˜ê²Œë©ë‹ˆë‹¤.
- actionìœ¼ë¡œ form ì œì¶œí•˜ë©´ nextjsì—ì„œ ìë™ìœ¼ë¡œ ìš”ì²­ì„ ìƒì„±í•˜ì—¬ ì›¹ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•˜ëŠ” NextJS ì„œë²„ë¡œ ë³´ë‚´ê²Œ ë©ë‹ˆë‹¤.
- server action í•¨ìˆ˜ëŠ” formDataë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- formDataëŠ” í•´ë‹¹ formì— ì‚¬ìš©ëœ ë°ì´í„°ë“¤ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.

```javascript
import { upload } from "@/lib/actions";
import PostSubmitBtn from "@/components/PostSubmitBtn";
import React from "react";

export default function UploadPost() {
  return (
    <form action={upload}>
      <div>
        <label htmlFor="title">title</label>
        <input
          id="title"
          name="title"
          type="text"
          placeholder="title"
          required
        />
      </div>
      <div>
        <label htmlFor="content">content</label>
        <input
          id="content"
          name="content"
          type="text"
          placeholder="content"
          required
        />
      </div>
      <PostSubmitBtn />
    </form>
  );
}
```

<br>

### revalidatePath & redirect
#### revalidatePath
```javascript
revalidatePath(path, type)
```
formì´ ì œì¶œëœ í›„ í™”ë©´ì˜ ë°ì´í„°ë¥¼ ìƒˆë¡œ í‘œì‹œ í•´ì£¼ì–´ì•¼í•©ë‹ˆë‹¤.

Next.jsëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë°ì´í„° ìºì‹± ê¸°ëŠ¥ìœ¼ë¡œ ê¸°ì¡´ ë°ì´í„°ë¥¼ ìºì‹±í•˜ê³  ìˆì–´ formì´ ì œì¶œëœ í›„ ìºì‹± ë°ì´í„°ë¥¼ ë¬´íš¨í™” í•´ì£¼ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ ìºì‹± ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ê²Œë©ë‹ˆë‹¤.

ê¸°ì¡´ ìºì‹± ë°ì´í„°ë¥¼ ë¬´íš¨í™” ì‹œí‚¤ê³ , ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ì„œ `revalidatePath` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
`revalidatePath`ëŠ” ìºì‹± ë°ì´í„°ë¥¼ ë¬´íš¨í™” ì‹œí‚¬ pathë¥¼ ì²«ë²ˆì§¸ ì¸ìë¡œ ë°›ìœ¼ë©´, ë‘ ë²ˆì§¸ ì¸ìë¡œ `layout` ë˜ëŠ” `page`ë¥¼ ì¸ìë¡œ ë°›ê²Œë©ë‹ˆë‹¤. ê¸°ë³¸ ê°’ìœ¼ë¡œëŠ” `layout`ì´ ì ìš©ë©ë‹ˆë‹¤.
- `layout` : í˜„ì¬ pathì— í¬í•¨ëœ í•˜ìœ„ ëª¨ë“  ê²½ë¡œì˜ ìºì‹œ ë°ì´í„°ë¥¼ ë¬´íš¨í™” ì‹œí‚¤ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤.
- `page` : í˜„ì¬ pathì™€ ì¼ì¹˜í•˜ëŠ” ê²½ë¡œì˜ ìºì‹œ ë°ì´í„°ë¥¼ ë¬´íš¨í™” ì‹œí‚¤ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤. 

#### Redirect
í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¥¼ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

<br>

### useFormStateë¥¼ í†µí•´ validate error ê´€ë¦¬í•˜ê¸°
`useFormState`ì€ form ì•¡ì…˜ì˜ ê²°ê³¼ì— ê¸°ë°˜í•˜ì—¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” hookì…ë‹ˆë‹¤.

- ì»´í¬ë„ŒíŠ¸ ìµœìƒìœ„ ë ˆë²¨ì—ì„œ useFormStateë¥¼ í˜¸ì¶œí•´ì„œ, form ì•¡ì…˜ì´ í˜¸ì¶œë  ë•Œ ì—…ë°ì´íŠ¸ë˜ëŠ” stateë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
- useFormStateì— formì˜ ì•¡ì…˜ í•¨ìˆ˜ì™€ ì´ˆê¸°ê°’ì„ ì „ë‹¬í•˜ë©´, formì— ì‚¬ìš©í•  ìƒˆë¡œìš´ ì•¡ì…˜ê³¼ ìµœì‹  stateë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
- ìµœì‹  stateëŠ” ì œê³µí•œ í•¨ìˆ˜ì—ë„ ì „ë‹¬ë©ë‹ˆë‹¤.
- formì˜ stateëŠ” formì´ ë§ˆì§€ë§‰ìœ¼ë¡œ ì œì¶œë˜ì—ˆì„ ë•Œ ì•¡ì…˜ì— ì˜í•´ ë°˜í™˜ëœ ê°’ì…ë‹ˆë‹¤.
- formì´ ì•„ì§ ì œì¶œë˜ì§€ ì•Šì•˜ë‹¤ë©´, ì´ˆê¸°ê°’ì„ ê°€ì§€ê²Œë©ë‹ˆë‹¤.

#### useFormState êµ¬ì„±
```javascript
const [state, formAction] = useFormState(fn, initialState, permalink?);
```

#### Parameters
- Fn : formì´ ì œì¶œë  ë•Œ í˜¸ì¶œí•  í•¨ìˆ˜ì…ë‹ˆë‹¤. ë‘ ê°œì˜ ì¸ìë¥¼ ë°›ìŠµë‹ˆë‹¤.
  - ì²« ë²ˆì§¸ ì¸ì ê°’ìœ¼ë¡œ formì˜ ì´ì „ stateë¥¼ ë°›ìŠµë‹ˆë‹¤.
  - ë‘ ë²ˆì§¸ ì¸ì ê°’ìœ¼ë¡œ form actionì´ ë°›ëŠ” ì¸ìë“¤ì„ ë°›ìŠµë‹ˆë‹¤.
- initialState : stateì˜ ì´ˆê¸°ê°’ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ì²˜ìŒ í˜¸ì¶œëœ í›„ì—ëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- permelink(optional) : formì´ ìˆ˜ì •í•˜ëŠ” ê³ ìœ  í˜ì´ì§€ URLì„ í¬í•¨í•˜ëŠ” ë¬¸ìì—´ì…ë‹ˆë‹¤.

#### Return
ë‘ ê°œì˜ ê°’ì´ ì¡´ì¬í•˜ëŠ” ë°°ì—´ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
- state : actionì— ì˜í•´ ë°˜í™˜ëœ ê°’ì…ë‹ˆë‹¤.
- action : formì—ì„œ ë²„íŠ¼ ì»´í¬ë„ŒíŠ¸ì˜ form action propìœ¼ë¡œ ì „ë‹¬í•  ìˆ˜ìˆëŠ” ìƒˆë¡œìš´ actionì…ë‹ˆë‹¤.

<br>

### useFormStateë¥¼ í†µí•œ form validate
upload í•¨ìˆ˜ì—ì„œ validateì— ì‚¬ìš©í•  errors ë°°ì—´ ìƒì„±í•©ë‹ˆë‹¤.

ì¡°ê±´ë¬¸ì„ í†µí•´ title, content validation ê²€ì‚¬í•©ë‹ˆë‹¤.

validation ê²€ì‚¬ë¥¼ í†µê³¼í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš° errors ë°°ì—´ ë°˜í™˜í•©ë‹ˆë‹¤.

ì´ë¥¼ useFormStateë¥¼ í†µí•´ errors stateë¥¼ ê°€ì ¸ì™€ ì—ëŸ¬ë¥¼ í‘œì‹œí•˜ë„ë¡ êµ¬í˜„í•©ë‹ˆë‹¤.

useFormStateì—ì„œ ë°˜í™˜í•˜ëŠ” ì¸ìê°’ì— ë§ê²Œ prevState íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•´ì¤ë‹ˆë‹¤.
```javascript
export async function upload(prevState: unknown, formData: FormData) {
  const title = formData.get("title") as string | null;
  const content = formData.get("content") as string | null;

  let errors = [];

  if (!title || title.trim().length === 0) {
    errors.push("Title is required.");
  }

  if (!content || content.trim().length === 0) {
    errors.push("Content is required.");
  }

  if (errors.length > 0) {
    return { errors };
  }

  const post = {
    title: formData.get("title"),
    content: formData.get("content"),
  };

  await savePost(post);

  revalidatePath("/posts");
  redirect("/posts");
}
```

UploadPost ì»´í¬ë„ŒíŠ¸ì— useFormStateë¥¼ ì ìš©í•˜ê³ , upload í•¨ìˆ˜ë¥¼ ì²« ë²ˆì§¸ ì¸ì ê°’ìœ¼ë¡œ ë„˜ê²¨ì¤ë‹ˆë‹¤.
```javascript
// app/upload/page.tsx

"use clinet";

import { upload } from "@/lib/serverActions";
import PostSubmitBtn from "@/components/PostSubmitBtn";
import React from "react";
import { useFormState } from "react-dom";

export default function UploadPost() {
  const [state, formAction]= useFormState(upload, { error : []});

  return (
    <form action={formAction}>
      <div>
        <label htmlFor="title">title</label>
        <input
          id="title"
          name="title"
          type="text"
          placeholder="title"
          required
        />
      </div>
      <div>
        <label htmlFor="content">content</label>
        <input
          id="content"
          name="content"
          type="text"
          placeholder="content"
          required
        />
      </div>
      <PostSubmitBtn />
      {state.errors &&
        state.errors.map((error) => (
          <p key={error} className="text-red-400 mr-2">
            {error}
          </p>
        ))}
    </form>
  );
}

```
Client Componentì•ˆì—ì„œ uploadì¸ Server Action í•¨ìˆ˜ë¥¼ ì‚¬ìš© í•˜ì˜€ê¸° ë•Œë¬¸ì— ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.
ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´, Server Action í•¨ìˆ˜ë¥¼ propë¡œ ë„˜ê²¨ì£¼ë„ë¡ ì»´í¬ë„ŒíŠ¸ë¥¼ ë¶„ë¦¬í•©ë‹ˆë‹¤.

PostForm ì»´í¬ë„ŒíŠ¸ë¥¼ ìƒì„±í•˜ì—¬ ë¶„ë¦¬í•©ë‹ˆë‹¤.
Server Actionë¥¼ propë¥¼ í†µí•´ ë°›ìŠµë‹ˆë‹¤.
```javascript
// app/components/PostFom.tsx

"use client";

import { useFormState } from "react-dom";
import PostSubmitBtn from "./PostSubmitBtn";

interface IProps {
  action: (
    prevState: unknown,
    formData: FormData
  ) => Promise<{
    errors: string[];
  }>;
}

export default function PostForm({ action }: IProps) {
  const [state, formAction] = useFormState(action, { errors: [] });

  return (
    <form
      action={formAction}
      className="flex flex-col justify-center items-center border max-w-[500px] mx-auto p-5 mt-20 shadow-md rounded-lg"
    >
      <h2 className="text-xl font-semibold mb-5">Post Form</h2>
      <div className="w-full">
        <label htmlFor="title" className="sr-only">
          title
        </label>
        <input
          className="border w-full mb-3 py-1 px-2 text-sm"
          id="title"
          name="title"
          type="text"
          placeholder="title"
          required
        />
      </div>
      <div className="w-full">
        <label htmlFor="content" className="sr-only">
          content
        </label>
        <textarea
          className="resize-none border p-2 text-sm h-[120px] w-full"
          id="content"
          name="content"
          placeholder="content"
          required
        />
      </div>
      <PostSubmitBtn />
      {state.errors &&
        state.errors.map((error) => (
          <p key={error} className="text-red-400 mr-2">
            {error}
          </p>
        ))}
    </form>
  );
}
```

upload Server Actionë¥¼ PostForm ì»´í¬ë„ŒíŠ¸ì˜ propë¥¼ í†µí•´ ì „ë‹¬í•©ë‹ˆë‹¤.
```javascript
// app/upload/page.tsx

"use clinet";

import { upload } from "@/lib/serverActions";
import PostForm from "../components/PostForm";

export default function UploadPost() {
  return <PostForm action={upload} />;
}
```

<br>

## 3-3. Server Action ì—ëŸ¬ ì²˜ë¦¬
Server Actionì—ì„œ `try/cath` êµ¬ë¬¸ì„ ì´ìš©í•˜ì—¬ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤ë©´ Next.jsì—ì„œëŠ” `error.tsx` íŒŒì¼ ì»´í¬ë„ŒíŠ¸ë¥¼ ë Œë”ë§í•˜ê²Œë©ë‹ˆë‹¤.

```javascript
export async function upload(prevState: unknown, formData: FormData) {
  const title = formData.get("title") as string | null;
  const content = formData.get("content") as string | null;

  let errors = [];

  if (!title || title.trim().length === 0) {
    errors.push("Title is required.");
  }

  if (!content || content.trim().length === 0) {
    errors.push("Content is required.");
  }

  if (errors.length > 0) {
    return { errors };
  }

  const post = {
    title: formData.get("title"),
    content: formData.get("content"),
  };

  try {
    await savePost(post);
  } catch (error) {
    console.error(error);
    return { message: "DB Error : Failed Saved Data." };
  }

  revalidatePath("/posts");
  redirect("/posts");
}
```


`error.tsx` íŒŒì¼ì€ í•´ë‹¹ ë¼ìš°íŠ¸ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ëª¨ë“  ì—ëŸ¬ë¥¼ ì¡ì•„ fallback UIë¥¼ ì‚¬ìš©ìì—ê²Œ ì œê³µí•©ë‹ˆë‹¤.
`error.tsx` íŒŒì¼ì€ ê° í˜ì´ì§€ ë§ˆë‹¤ ë‹¤ë¥´ê²Œ ì„¤ì •í•  ìˆ˜ ìˆìœ¼ë©°, ë‘ ê°œ(error, reset)ì˜ propsë¥¼ ì „ë‹¬ ë°›ìŠµë‹ˆë‹¤.
- `error` : JSì˜ Error ê°ì²´ ì¸ìŠ¤í„´ìŠ¤ì…ë‹ˆë‹¤.
- `reset` : ì—ëŸ¬ ë°”ìš´ë”ë¦¬ë¥¼ resetí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
```javascript
// app/upload/error.tsx
"use client";

import Error from "next/error";
import React, { useEffect } from "react";

interface IProps {
  error: Error & { digest?: string; message?: string };
  reset: () => void;
}

export default function UploadError({ error, reset }: IProps) {
  useEffect(() => {
    // Log the error to an error reporting service
    console.error(error);
  }, [error]);

  return (
    <div>
      <h2>{error.message}</h2>
      <button
        onClick={
          // Attempt to recover by trying to re-render the segment
          () => reset()
        }
      >
        Try again
      </button>
    </div>
  );
}
```