# 4. Server Action

## 1. Server Action ?

> formì˜ mutation(ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ)ì„ í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë„¥ìŠ¤íŠ¸ì˜ ì•„ì£¼ ê°•ë ¥í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.

ì„œë²„ ì•¡ì…˜ì„ ì‚¬ìš©í•˜ë©´, API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ìƒì„±í•˜ì§€ ì•Šê³ ë„ ì»´í¬ë„ŒíŠ¸ ë‚´ì—ì„œ ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ ì§ì ‘ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br/>

## 2. Server Action ì •ì˜ ë°©ë²•

í•¨ìˆ˜ ìƒë‹¨ì— â€˜use serverâ€™ë¥¼ ì„ ì–¸í•˜ê³ , async í‚¤ì›Œë“œë¥¼ ë¶™ì´ë©´ ì„œë²„ì—ì„œ ë™ì‘í•˜ëŠ” í•¨ìˆ˜ê°€ ë©ë‹ˆë‹¤.

í•œ íŒŒì¼ ë‚´ì— ì—¬ëŸ¬ Server Functionë¥¼ ì •ì˜í•˜ëŠ” ê²½ìš° íŒŒì¼ ìµœìƒë‹¨ì— â€˜use Serverâ€™ë¥¼ í•œë²ˆë§Œ ì„ ì–¸í•˜ë©´ë©ë‹ˆë‹¤.

```jsx
'use client'
export default function App() {
	async function DeletePost() {
			'use server"
			//...
	}
//...
}

```

```jsx
'use server'
async function DeletePost() {
		//...
}

async function UploadPost() {
		//...
}
```

<br/>

## 3. Server Action ì‚¬ìš©í•˜ê¸°

Server Action ì‚¬ìš©ì„ ìœ„í•´ ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì„ ìœ„í•´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.

```bash
npm install -D better-sqlite3
```

<br/>

### 1 ) ë°ì´í„° ë² ì´ìŠ¤ ìƒì„±

**db.js**

```bash
const sql = require("better-sqlite3");
const db = sql("posts.db");

const dummyPosts = [
  {
    title:
      "sunt aut facere repellat provident occaecati excepturi optio reprehenderit",
    content:
      "quia et suscipit\nsuscipit recusandae consequuntur expedita et cum\nreprehenderit molestiae ut ut quas totam\nnostrum rerum est autem sunt rem eveniet architecto",
  },
  {
    title: "qui est esse",
    content:
      "est rerum tempore vitae\nsequi sint nihil reprehenderit dolor beatae ea dolores neque\nfugiat blanditiis voluptate porro vel nihil molestiae ut reiciendis\nqui aperiam non debitis possimus qui neque nisi nulla",
  },
  {
    title: "ea molestias quasi exercitationem repellat qui ipsa sit aut",
    content:
      "et iusto sed quo iure\nvoluptatem occaecati omnis eligendi aut ad\nvoluptatem doloribus vel accusantium quis pariatur\nmolestiae porro eius odio et labore et velit aut",
  },
  {
    title: "eum et est occaecati",
    content:
      "ullam et saepe reiciendis voluptatem adipisci\nsit amet autem assumenda provident rerum culpa\nquis hic commodi nesciunt rem tenetur doloremque ipsam iure\nquis sunt voluptatem rerum illo velit",
  },
  {
    title: "nesciunt quas odio",
    content:
      "repudiandae veniam quaerat sunt sed\nalias aut fugiat sit autem sed est\nvoluptatem omnis possimus esse voluptatibus quis\nest aut tenetur dolor neque",
  },
];

db.prepare(
  `
   CREATE TABLE IF NOT EXISTS posts (
       id INTEGER PRIMARY KEY AUTOINCREMENT,
       title TEXT NOT NULL,
			 content TEXT NOT NULL
    )
`
).run();

async function initData() {
  const stmt = db.prepare(`
      INSERT INTO posts VALUES (
         null,
         @title,
         @content
      )
   `);

  for (const post of dummyPosts) {
    stmt.run(post);
  }
}

initData();

```

ì•„ë˜ ëª…ë ¹ì–´ë¡œ posts.db ìƒì„±

```bash
node db.js
```

<br/>

**actions.js**

dbë¥¼ ë¶ˆëŸ¬ì˜¬ í•¨ìˆ˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

better-sqlite3ëŠ” ë™ê¸°ì ìœ¼ë¡œ ë™ì‘í•˜ì—¬ ë¹„ë™ê¸° ì½”ë“œê°€ í•„ìš”ì—†ì§€ë§Œ ì‹¤ì œ dbì—ì„œëŠ” ë¹„ë™ê¸°ì ìœ¼ë¡œ ë™ì‘ í•˜ë¯€ë¡œ, promiseë¥¼ ë§Œë“¤ì–´ 2ì´ˆë™ì•ˆ ëŒ€ê¸°ìƒíƒœê°€ ë˜ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.

server actionìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ â€˜use serverâ€™ë¥¼ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤.

```bash
'use server'
import sql from "better-sqlite3";

const db = sql("posts.db");
export const getPosts = async () => {
  await Promise((res) => setTimeout(res, 2000));
  return db.prepare("SELECT * FROM posts").all();
};
```

<br/>

**Posts.js**

postsë¥¼ dbì—ì„œ ë¶ˆëŸ¬ì™€ í™”ë©´ì— ì¶œë ¥í•˜ì˜€ìŠµë‹ˆë‹¤.

```bash
import { getPosts } from "@/lib/actions";

export default async function Posts() {
  const postsData = await getPosts();
  return (
    <>
      <header>
        <h1>Posts Page</h1>
      </header>
      <main>
        <h2>Posts</h2>
        <ul>
          {postsData.map((data) => {
            return (
              <li key={data.id}>
                <h3>{data.title}</h3>
                <div>{data.content}</div>
              </li>
            );
          })}
        </ul>
      </main>
    </>
  );
}

```

<br/>

### **2 ) post Upload**

**actions.js**

upload í•¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤.

```jsx
"use server";
import sql from "better-sqlite3";
import { redirect } from "next/navigation";

const db = sql("posts.db");
export const getPosts = async () => {
  await new Promise((res) => setTimeout(res, 2000));
  return db.prepare("SELECT * FROM posts").all();
};

export async function upload(formData) {
  const post = {
    title: formData.get("title"),
    content: formData.get("content"),
  };

  await savePost(post);
  redirect("/posts");
}

export async function savePost(post) {
  db.prepare(`
    INSERT INTO posts
      (title, content)
    VALUES (
      @title,
      @content
    )
  `).run(post);
}

```

<br/>

**UploadPost.js**

postë¥¼ ì—…ë¡œë“œí•˜ëŠ” ì»´í¬ë„ŒíŠ¸ ì…ë‹ˆë‹¤.

actionsì—ì„œ upload í•¨ìˆ˜ë¥¼ ë¶ˆëŸ¬ì™€ ì‚¬ìš©í•©ë‹ˆë‹¤.

form actionì— upload í•¨ìˆ˜ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.

<br/>

ğŸ’¡ **from action**

from actionì€ ë°ì´í„°ê°€ ì „ì†¡ë  ì„œë²„ì˜ URLì„ ì§€ì •í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

nextjsì—ì„œ server actionë¥¼ ì „ë‹¬í•˜ë©´ server actions ê¸°ëŠ¥ìœ¼ë¡œ ë™ì‘í•˜ê²Œë©ë‹ˆë‹¤.

actionìœ¼ë¡œ form ì œì¶œí•˜ë©´ nextjsì—ì„œ ìë™ìœ¼ë¡œ ìš”ì²­ì„ ìƒì„±í•˜ì—¬ ì›¹ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•˜ëŠ” NextJS ì„œë²„ë¡œ ë³´ë‚´ê²Œ ë©ë‹ˆë‹¤.

server action í•¨ìˆ˜ëŠ” formDataë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

formDataëŠ” í•´ë‹¹ formì— ì‚¬ìš©ëœ ë°ì´í„°ë“¤ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.

```jsx
import { upload } from "@/lib/actions";
import React from "react";

export default function UploadPost() {
  return (
    <form action={upload}>
      <div>
        <label htmlFor="title">title</label>
        <input
          id="title"
          name="title"
          type="text"
          placeholder="title"
          required
        />
      </div>
      <div>
        <label htmlFor="content">content</label>
        <input
          id="content"
          name="content"
          type="text"
          placeholder="content"
          required
        />
      </div>
      <button type="submit">submit</button>
    </form>
  );
}

```

<br/>

### 3 ) ì‚¬ìš©ìì—ê²Œ ë¡œë”© ìƒíƒœì•Œë¦¬ê¸°

`useFormStatus` hookë¥¼ ì‚¬ìš©í•˜ë©´ í˜„ì¬ í¼ ë¡œë”© ìƒíƒœë¥¼ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`useFormStatus` : react-domì—ì„œ ì œê³µí•˜ëŠ” hookìœ¼ë¡œ pending ìƒíƒœë¥¼ ë°˜í™˜í•˜ì—¬ í˜„ì¬ í¼ ë¡œë”© ìƒíƒœë¥¼ ì•Œë ¤ì¤ë‹ˆë‹¤.

**SubmitButton.js**

useFormStausë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ í¼ì˜ ë¡œë”© ìƒíƒœë¥¼ ì•Œë ¤ì£¼ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.

useFormStatus ì‚¬ìš©í•˜ë ¤ë©´ client componentê°€ ë˜ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— button ì»´í¬ë„ŒíŠ¸ë¥¼ ë”°ë¡œ ìƒì„±í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.

```jsx
"use client";
import { useFormStatus } from "react-dom";

export default function SubmitButton() {
  const status = useFormStatus();
  return (
    <button type="submit" disabled={status.pending}>
      {status.pending ? "submiting..." : "submit"}
    </button>
  );
}

```

<br/>

**Uploadpost.js**

```jsx
import { upload } from "@/lib/actions";
import React from "react";

export default function UploadPost() {
  return (
    <form action={upload}>
      <div>
        <label htmlFor="title">title</label>
        <input
          id="title"
          name="title"
          type="text"
          placeholder="title"
          required
        />
      </div>
      <div>
        <label htmlFor="content">content</label>
        <input
          id="content"
          name="content"
          type="text"
          placeholder="content"
          required
        />
      </div>
      <SubmitButton />
    </form>
  );
}
```